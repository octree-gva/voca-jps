jpsType: install
jpsVersion: '1.7.4'

name: Infra/DecidimEnv
id: decidim-vanilla-infra-environment
description:
  short: Create a dummy Decidim environment
categories:
  - apps/platforms
baseUrl: https://raw.githubusercontent.com/octree-gva/voca-jps/main
logo: assets/decidim_logo.png
ssl: true
ha: false

mixins:
  - /scripts/mixins/globals.yml?_r=${fn.random}
# Set environments values
onBeforeInit: /scripts/deploy/deploy-settings.js?_r=${fn.random}

nodes:
  - displayName: nginx
    fixedCloudlets: 3
    flexibleCloudlets: 16
    diskLimit: 5G
    nodeGroup: bl
    nodeType: nginx-dockerized
    tag: 1.20.2
    volumes:
      - /public
      - /etc/nginx/nginx-jelastic.conf
      - /etc/jelastic/redeploy.conf
    volumeMounts:
      # Serve assets from the storage node
      /public:
        protocol: NFS4
        readOnly: true
        sourceNodeGroup: storage
        sourcePath: '/data'
    links:
      # Link to app in order to proxy_pass http://app
      - cp:app
    skipNodeEmails: true
    isSLBAccessEnabled: false


  # Decidim application
  - displayName: public
    fixedCloudlets: 4
    flexibleCloudlets: 16
    diskLimit: 100G
    count: 1
    env:
      APP_SESSION_KEY: '${globals.APP_SESSION_KEY}'
      INSTANCE_UUID: '${settings.INSTANCE_UUID}'
      DATABASE_HOST: psql
      DATABASE_PASSWORD: '${globals.DB_PASSWORD}'
      DATABASE_DATABASE: decidim
      DATABASE_USERNAME: '${globals.DB_USER}'
      DATABASE_URL: postgres://${globals.DB_USER}:${globals.DB_PASSWORD}@psql:5432/decidim
      SECRET_KEY_BASE: '${globals.SECRET_KEY_BASE}'
      MASTER_KEY: '${globals.MASTER_KEY}'
      RAILS_FORCE_SSL: 'disabled'
      RAILS_CACHE_MODE: 'redis'
      CACHE_REDIS_URL: 'redis://default:${globals.REDIS_PASSWORD}@redis:6379/0'
      RAILS_JOB_MODE: 'sidekiq'
      JOB_REDIS_URL: 'redis://default:${globals.REDIS_PASSWORD}@redis:6379/1'
      DECIDIM_RUN_PUMA: '1'
      DECIDIM_RUN_SIDEKIQ: '0'
      DECIDIM_RUN_GRPC: '0'
      DECIDIM_RUN_CRON: '0'
    links:
      - sqldb:psql
      - nosqldb:redis
    image: '${settings.IMAGE_PATH}'
    registry:
      url: '${settings.IMAGE_REGISTRY}'
      user: '${settings.IMAGE_USERNAME}'
      password: '${settings.IMAGE_PASSWORD}'
    nodeGroup: cp
    isSLBAccessEnabled: false
    volumes:
      - /home/decidim/app/public
    volumeMounts:
      /home/decidim/app/public:
        protocol: NFS4
        readOnly: false
        sourceNodeGroup: storage
        sourcePath: '/data'
      /home/decidim/app/db/migrate:
        protocol: NFS4
        readOnly: false
        sourceNodeGroup: storage
        sourcePath: '/migrations'

  # Decidim runner (sidekiq+tasks)
  - displayName: worker
    fixedCloudlets: 4
    flexibleCloudlets: 30 # needed for compilation time.
    diskLimit: 5G
    env:
      APP_SESSION_KEY: '${globals.APP_SESSION_KEY}'
      INSTANCE_UUID: '${settings.INSTANCE_UUID}'
      DATABASE_HOST: psql
      DATABASE_PASSWORD: '${globals.DB_PASSWORD}'
      DATABASE_DATABASE: decidim
      DATABASE_USERNAME: '${globals.DB_USER}'
      SECRET_KEY_BASE: '${globals.SECRET_KEY_BASE}'
      RAILS_CACHE_MODE: 'redis'
      CACHE_REDIS_URL: 'redis://default:${globals.REDIS_PASSWORD}@redis:6379/0'
      RAILS_JOB_MODE: 'sidekiq'
      JOB_REDIS_URL: 'redis://default:${globals.REDIS_PASSWORD}@redis:6379/1'
      DOCKER_EXPOSED_PORT: 3000
      PORT: 3000
      WEBHOOK_URL: '${settings.WEBHOOK_URL}'
      DECIDIM_RUN_PUMA: '0'
      DECIDIM_RUN_SIDEKIQ: '1'
      DECIDIM_RUN_GRPC: '1'
      DECIDIM_RUN_CRON: '1'
    links:
      - sqldb:psql
      - nosqldb:redis
    isSLBAccessEnabled: false
    image: '${settings.IMAGE_PATH}'
    registry:
      url: '${settings.IMAGE_REGISTRY}'
      user: '${settings.IMAGE_USERNAME}'
      password: '${settings.IMAGE_PASSWORD}'
    nodeGroup: vocacity
    volumes:
      - /home/decidim/app/public
    volumeMounts:
      /home/decidim/app/public:
        protocol: NFS4
        readOnly: false
        sourceNodeGroup: storage
        sourcePath: '/data'
      /home/decidim/app/db/migrate:
        protocol: NFS4
        readOnly: false
        sourceNodeGroup: storage
        sourcePath: '/migrations'

  # DATA : postgres database
  - displayName: postgres
    fixedCloudlets: 3
    flexibleCloudlets: 12
    diskLimit: 100G
    nodeGroup: sqldb
    image: postgres:12
    isSLBAccessEnabled: false
    env:
      POSTGRES_PASSWORD: '${globals.DB_PASSWORD}'
      POSTGRES_DB: decidim
      POSTGRES_USER: '${globals.DB_USER}'
      ADMINPANEL_ENABLED: false
      LC_ALL: 'en_US.UTF-8'
    volumes:
      - '/var/lib/postgresql/data'

  # Cache and Queue
  - displayName: redis
    image: jelastic/redis:6.2.6
    fixedCloudlets: 2
    flexibleCloudlets: 16
    nodeGroup: nosqldb
    isSLBAccessEnabled: false
    env:
      ADMINPANEL_ENABLED: false

  # DATA : shared public folder
  - displayName: files
    cloudlets: 2
    diskLimit: 100G
    nodeGroup: storage
    nodeType: storage
    tag: 2.0-9.4
    isSLBAccessEnabled: false
    env:
      HOME_DIR: '/data'
    volumes:
      - /data
      - /migrations

onInstall:
  - redisSetPassword
  - nginxSetup
  - createMigrations

actions:
  redisSetPassword:
    - cmd[nosqldb]: jem passwd set -p ${globals.REDIS_PASSWORD}
    - cmd[nosqldb]:
        echo "time=\"$(date +%FT%TZ)\" level=info msg=\"Redis password
        changed\"" >> /var/log/run.log
  nginxSetup:
    - install:
      jps: scripts/deploy/nginx-conf.yml?_r=${fn.random}
      envName: ${env.envName}
      loggerName: 'Decidim-Nginx'
    - restartNode [bl]
  createMigrations:
    - cmd[vocacity]: cd $HOME && bundle exec rails --tasks | grep -E 'rails [^ ]*:install:migrations' | awk -F ' ' '{ print "bundle exec rails " $2 ";" }' | bash

success: |
  Someone created a decidim. This email contains private informations, and should
  be deleted as soon as you review the instance [${settings.PUBLIC_DOMAIN}](${settings.PUBLIC_DOMAIN}).

  # Seed and compilation?
  The seed and compilation are done over GRPC, and not on infrastructure setups.
  The only permanent setting is the timezone: `${settings.TIMEZONE}`.

  # Routing file?
  The routing file is not defined yet, as the environment is not bound to an instance.

  # What are the secrets used in the installation?

  * Postgres:
    * password: `${globals.DB_PASSWORD}`
    * username: `${globals.DB_USER}`
  * Redis:
    * password: `${globals.REDIS_PASSWORD}`
    * username: `${globals.REDIS_USER}`
  * Rails:
    * APP_SESSION_KEY: `${globals.APP_SESSION_KEY}`
    * SECRET_KEY_BASE: `${globals.SECRET_KEY_BASE}`
    * MASTER_KEY: `${globals.MASTER_KEY}`

  # Next steps?
  Bind an instance.
