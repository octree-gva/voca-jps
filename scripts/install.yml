jpsType: update
jpsVersion: '1.7.4'

name: Decidim/Install
id: decidim-vanilla-decidim-install
description:
  short: Install Decidim on a dummy environment
categories:
  - apps/platforms
baseUrl: https://raw.githubusercontent.com/octree-gva/voca-jps/main
logo: assets/decidim_logo.png
ssl: true
ha: false
skipNodeEmails: true

onBeforeInit: /scripts/deploy/install-settings.js?_r=${fn.random}

onInstall:
  # Update the display name from parked to the display name
  - setDisplayName
  # Update the environment vars
  - addEnvVars
  # Install new migration if the template requires new 
  - createMigrations
  - prepare

actions:
  setDisplayName:
    - env.control.SetEnvDisplayName:
      displayName: "${settings.PUBLIC_URL}"
  addEnvVars:
    - env.control.AddContainerEnvVars[cp]:
      vars: {"TZ":"${settings.TIMEZONE}","DECIDIM_CURRENCY_UNIT":"${settings.DECIDIM_CURRENCY_UNIT}"}
    - env.control.AddContainerEnvVars[bl]:
      vars: {"PUBLIC_URL":"${settings.PUBLIC_URL}"}
    - env.control.RestartNodes[cp]
  createMigrations:
    - cmd[cp]:
      - cd $ROOT;
      - bundle exec rails --tasks | grep -E 'rails [^ ]*:install:migrations' | awk -F ' ' '{ print "bundle exec rails " $2 ";" }' | bash
      - bundle exec rails --tasks | grep -E 'rails [^ ]*:webpacker:install' | awk -F ' ' '{ print "bundle exec rails " $2 ";" }' | bash
      - npm install

  prepare:
    - cmd[cp]: |
        cd $ROOT;
        bundle exec rails db:migrate;
        bundle exec rails assets:precompile;

success: |
  The instance ${settings.PUBLIC_URL} is ready to be bound to ${env.envName}
startPage: ${settings.PUBLIC_URL}
