jpsType: update
jpsVersion: '1.7.4'

name: Template/Create
id: create-voca-template
description:
  short: Create a voca template
categories:
  - apps/platforms
baseUrl: https://raw.githubusercontent.com/octree-gva/voca-jps/main
logo: assets/decidim_logo.png
ssl: true
ha: false
skipNodeEmails: true

settings:
  fields:
    - name: ENV_NAME
      type: string
      caption: Env name of the source backup
    - name: RESTIC_REPOSITORY
      type: string
      caption: Host+bucket+region for the S3
    - name: AWS_ACCESS_KEY_ID
      type: string
      caption: Key ID for S3
    - name: AWS_SECRET_ACCESS_KEY
      type: string
      caption: Secret for S3
    - name: RESTIC_PASSWORD
      type: string
      caption: Key used for restic encryption
    - name: AWS_DEFAULT_REGION
      type: string
      caption: Default Region
      default: "ch-dk-2"
    - name: TEMPLATE_NAME
      type: string
      caption: Name of the new template
onInstall:
  - restore
actions:

  restore:
    - cmd[storage]:
      - cd /data
      - tar cfz "/tmp/data-$(date +%Y%m%d%H%M%S).bak.tar.gz" -C /data .
      - cd /
      - rm -rf data/*
    - cmd[storage]:
      - yum install -y jq restic
      - export RESTIC_REPOSITORY="s3:${settings.RESTIC_REPOSITORY}/${settings.ENV_NAME}"
      - export AWS_ACCESS_KEY_ID="${settings.AWS_ACCESS_KEY_ID}"
      - export AWS_SECRET_ACCESS_KEY="${settings.AWS_SECRET_ACCESS_KEY}"
      - export RESTIC_PASSWORD="${settings.RESTIC_PASSWORD}"
      - export AWS_DEFAULT_REGION="${settings.AWS_DEFAULT_REGION}"
      - if ! restic snapshots >/dev/null 2>&1; then exit 1; fi
      - export SNAPSHOT_ID=$(restic snapshots --latest 1 --json | jq -r '.[0].id') 
      - restic restore $SNAPSHOT_ID --target /
  cleanup:
    - cmd[storage]: rm -rf /data/*.sql
      
success: |
  The new template "${settings.TEMPLATE_NAME}" has been created.
